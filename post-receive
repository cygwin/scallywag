#!/usr/bin/env python3
#
# post-receive hook to start a package build via appveyor REST API
#

import json
import os
import subprocess
import urllib.error
import urllib.request

account = subprocess.check_output(['git', 'config', 'appveyor.account']).strip().decode('ascii')
token = subprocess.check_output(['git', 'config', 'appveyor.token']).strip().decode('ascii')
slug = 'scallywag'


def post_receive():
    repo = os.environ['GL_REPO']  # set by gitolite
    maintainer = os.environ['CYGNAME']  # set for ssh-wrapper


    _, package = os.path.split(repo)
    package, _ = os.path.splitext(package)
    data = {
        "accountName": account,
        "projectSlug": slug,
        "branch": "master",
        "environmentVariables": {
            "PACKAGE": package,
            "MAINTAINER": maintainer,
        }
    }

    req = urllib.request.Request('https://ci.appveyor.com/api/builds')

    req.add_header('Content-Type', 'application/json')
    req.add_header('Accept', 'application/json')
    req.add_header('Authorization', 'Bearer ' + token)

    try:
        response = urllib.request.urlopen(req, json.dumps(data).encode('utf-8'))
    except urllib.error.URLError as e:
        response = e

    status = response.getcode()
    if status != 200:
        print('scallywag: webhook failed status %s' % (status))
        return

    j = json.loads(response.read().decode('utf-8'))
    print('scallywag: build %s queued' % j['buildNumber'])


if __name__ == '__main__':
    for line in sys.stdin.readlines():
        old, new, ref = line.strip().split()
        if ref == 'refs/heads/master':
            # only do something if master ref is updated
            post_receive()
